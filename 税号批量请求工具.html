<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ç¨å·æ‰¹é‡è¯·æ±‚å·¥å…·</title>
		<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
		<style>
			/* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
			* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-top: 20px;
        }
        
        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .right-panel {
            width: 380px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 100px); /* é™åˆ¶å³ä¾§é¢æ¿æœ€é«˜ä¸ºé¡µé¢é«˜åº¦ */
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }
        
        h2 {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        /* ä¸Šä¼ åŒºåŸŸæ”¹ä¸ºå››åˆ†ä¹‹ä¸€å®½åº¦ */
        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .upload-container {
            width: 25%;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 6px;
            padding: 30px 15px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .upload-area:hover {
            background-color: #f8f9fa;
            border-color: #2980b9;
        }
        
        .upload-icon {
            font-size: 36px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        #fileInput {
            display: none;
        }
        
        /* æ–°å¢åŒºåŸŸå å››åˆ†ä¹‹ä¸‰å®½åº¦ */
        .input-section {
            width: 75%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-row button {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .status-item {
            color: #2c3e50;
            font-size: 14px;
        }
        
        .status-value {
            font-weight: 600;
            color: #3498db;
        }
        
        .result-area {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-y: auto;
            background-color: #fafafa;
            margin-bottom: 20px;
        }
        
        .statistics {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .result-list {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto; /* è¶…å‡ºé«˜åº¦æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            margin-top: 10px;
        }
        
        .result-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 3px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .result-item.success {
            border-left-color: #2ecc71;
            background-color: #f8fff8;
        }
        
        .result-item.error {
            border-left-color: #e74c3c;
            background-color: #fff8f8;
        }
        
        .result-taxid {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .result-message {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
		</style>
	</head>
	<body>
		<div class="container">
			<div class="left-panel">
				<h2>1. ä¸Šä¼ Excelæ–‡ä»¶åŠå‚æ•°è®¾ç½® </h2>
				<div class="upload-section">
					<div class="upload-container">
						<div class="upload-area" id="uploadArea">
							<div class="upload-icon">ğŸ“Š</div>
							<div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ <div id="currentTime" class="status-item"></div>
							</div>
							<div class="upload-text" style="font-size: 12px; margin-top: 5px;">æ”¯æŒ.xls, .xlsxæ ¼å¼ï¼Œéœ€åŒ…å«"ç¨å·"åˆ—</div>
							<input type="file" id="fileInput" accept=".xls,.xlsx" />
						</div>
					</div>
					<div class="input-section">
						<div class="input-row">
							<input type="text" placeholder="å‚æ•°1" />
							<input type="text" placeholder="å‚æ•°2" />
							<button>åº”ç”¨</button>
						</div>
						<div class="input-row">
							<input type="text" placeholder="å‚æ•°3" />
							<input type="text" placeholder="å‚æ•°4" />
							<button>éªŒè¯</button>
						</div>
						<div class="input-row">
							<input type="text" placeholder="å‚æ•°5" />
							<input type="text" placeholder="å‚æ•°6" />
							<button>è®¾ç½®</button>
						</div>
						<div class="input-row">
							<input type="text" placeholder="å‚æ•°7" />
							<input type="text" placeholder="å‚æ•°8" />
							<button>å°¼ç›</button>
						</div>
					</div>
				</div>
				<div id="fileInfo" class="hidden">
					<div class="status-bar">
						<div class="status-item">å·²é€‰æ‹©æ–‡ä»¶: <span id="fileName" class="status-value"></span></div>
						<div class="status-item">ç¨å·æ•°é‡: <span id="taxCount" class="status-value">0</span></div>
					</div>
				</div>
				<h2>2. æ‰¹é‡è¯·æ±‚æ§åˆ¶</h2>
				<div class="control-group">
					<button id="startBtn" class="btn btn-primary btn-disabled" disabled>å¼€å§‹æ‰¹é‡è¯·æ±‚</button>
					<button id="stopBtn" class="btn btn-disabled" disabled style="margin-left: 10px; background-color: #e74c3c; color: white;">åœæ­¢è¯·æ±‚</button>
				</div>
				<div class="progress-container">
					<div id="progressBar" class="progress-bar"></div>
				</div>
				<div class="status-bar">
					<div class="status-item">å½“å‰è¿›åº¦: <span id="progressText" class="status-value">0/0</span></div>
					<div class="status-item">è¯·æ±‚çŠ¶æ€: <span id="requestStatus" class="status-value">æœªå¼€å§‹</span></div>
				</div>
				<h2>3. å®æ—¶è¯·æ±‚æ—¥å¿—</h2>
				<div id="logArea" class="result-area"></div>
				<h2>4. è¯·æ±‚ç»“æœç»Ÿè®¡</h2>
				<div id="statisticsArea" class="statistics hidden">
					<div class="stat-item">
						<span>æ€»è¯·æ±‚æ•°</span>
						<span id="totalRequests" class="status-value">0</span>
					</div>
					<div class="stat-item">
						<span>æˆåŠŸæ•°</span>
						<span id="successCount" class="status-value">0</span>
					</div>
					<div class="stat-item">
						<span>å¤±è´¥æ•°</span>
						<span id="errorCount" class="status-value">0</span>
					</div>
					<div id="messageStats"></div>
				</div>
			</div>
			<div class="right-panel">
				<h2>5. è¯¦ç»†ç»“æœåˆ—è¡¨</h2>
				<div class="status-bar">
					<div class="status-item">ç»“æœæ€»æ•°: <span id="resultCount" class="status-value">0</span></div>
				</div>
				<div id="resultList" class="result-list">
					<div style="text-align: center; color: #7f8c8d; padding: 20px;">
						æš‚æ— è¯·æ±‚ç»“æœ
					</div>
				</div>
			</div>
		</div>

		<script>
			// å…¨å±€å˜é‡
			let taxIds = []; // å­˜å‚¨ç¨å·æ•°ç»„
			let isRequesting = false; // æ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸­
			let currentIndex = 0; // å½“å‰è¯·æ±‚ç´¢å¼•
			let requestStats = { // è¯·æ±‚ç»Ÿè®¡
				total: 0,
				success: 0,
				error: 0,
				messages: {}
			};
			let stopRequested = false; // æ˜¯å¦è¯·æ±‚åœæ­¢

			// DOMå…ƒç´ 
			const fileInput = document.getElementById('fileInput');
			const uploadArea = document.getElementById('uploadArea');
			const fileInfo = document.getElementById('fileInfo');
			const fileName = document.getElementById('fileName');
			const taxCount = document.getElementById('taxCount');
			const startBtn = document.getElementById('startBtn');
			const stopBtn = document.getElementById('stopBtn');
			const logArea = document.getElementById('logArea');
			const progressBar = document.getElementById('progressBar');
			const progressText = document.getElementById('progressText');
			const requestStatus = document.getElementById('requestStatus');
			const statisticsArea = document.getElementById('statisticsArea');
			const totalRequests = document.getElementById('totalRequests');
			const successCount = document.getElementById('successCount');
			const errorCount = document.getElementById('errorCount');
			const messageStats = document.getElementById('messageStats');
			const resultList = document.getElementById('resultList');
			const resultCount = document.getElementById('resultCount');
			const currentTime = document.getElementById('currentTime');
			let dqspid = "" //å½“å‰spidï¼ˆä¿®æ­£ï¼šç”¨letè€Œévarï¼Œè§„èŒƒå˜é‡å£°æ˜ï¼‰

			// æ”¹é€ getspidï¼šè¿”å›Promiseï¼Œæ”¯æŒawait
			function getspid(qysh) { 
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest();
					const requestParams = {
						token: localStorage.getItem("youtoken"),
						qysh: qysh,
					};
					const apiUrlV = 'https://51dzfp.cn/NEWKP//TERM/KPFJLIST';
					const queryStringV = new URLSearchParams(requestParams).toString();
					const fullUrlV = `${apiUrlV}?${queryStringV}`;
					xhr.open('post', fullUrlV, true);
					xhr.onload = function() {
						if (xhr.status >= 200 && xhr.status < 300) {
							try {
								const response = JSON.parse(xhr.responseText);
								if (response.rows.length>0) {
									dqspid = response.rows[0].SPID;
									showLog(`è·å–åˆ°å¯¹åº”ç¨å·[${qysh}]ä¿¡æ¯: spid=${dqspid} åˆ†æœºå·=${response.rows[0].FJH}`, "success");
									resolve(dqspid); // æˆåŠŸæ—¶è¿”å›spid
								} else {
									const errMsg = `ç¨å·[${qysh}]æœªè¿”å›æœ‰æ•ˆspidæ•°æ®`;
									showLog(errMsg, "error");
									reject(new Error(errMsg));
								}
							} catch (e) {
								const errMsg = `è§£æspidå“åº”å¤±è´¥: ${e.message}`;
								showLog(errMsg, "error");
								reject(new Error(errMsg));
							}
						} else {
							const errMsg = `è·å–spidå¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : ${xhr.status}`;
							showLog(errMsg, "error");
							reject(new Error(errMsg));
						}
					};

					xhr.onerror = function() {
						const errMsg = `ç¨å·[${qysh}]è·å–spidæ—¶ç½‘ç»œé”™è¯¯`;
						showLog(errMsg, "error");
						reject(new Error(errMsg));
					};

					xhr.ontimeout = function() {
						const errMsg = `ç¨å·[${qysh}]è·å–spidè¯·æ±‚è¶…æ—¶`;
						showLog(errMsg, "error");
						reject(new Error(errMsg));
					};

					// ä¿®æ­£ï¼šåŸä»£ç xhr.send(params)ä¸­paramsæœªå®šä¹‰ï¼Œè¡¥å……å‚æ•°
					const params = new URLSearchParams(requestParams).toString();
					xhr.send(params);
				});
			}

			// æ›´æ–°å½“å‰æ—¶é—´
			function updateCurrentTime() {
				const now = new Date();
				currentTime.textContent = now.toLocaleString('zh-CN');
			}
			setInterval(updateCurrentTime, 1000);
			updateCurrentTime();

			// ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
			uploadArea.addEventListener('click', () => {
				fileInput.click();
			});

			// æ‹–æ‹½äº‹ä»¶
			uploadArea.addEventListener('dragover', (e) => {
				e.preventDefault();
				uploadArea.style.backgroundColor = '#f0f7ff';
			});

			uploadArea.addEventListener('dragleave', () => {
				uploadArea.style.backgroundColor = '';
			});

			uploadArea.addEventListener('drop', (e) => {
				e.preventDefault();
				uploadArea.style.backgroundColor = '';

				if (e.dataTransfer.files.length > 0) {
					const file = e.dataTransfer.files[0];
					handleFileUpload(file);
				}
			});

			// æ–‡ä»¶é€‰æ‹©äº‹ä»¶
			fileInput.addEventListener('change', (e) => {
				if (e.target.files.length > 0) {
					const file = e.target.files[0];
					handleFileUpload(file);
				}
			});

			// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
			function handleFileUpload(file) {
				// éªŒè¯æ–‡ä»¶ç±»å‹
				const fileExtension = file.name.split('.').pop().toLowerCase();
				if (fileExtension !== 'xls' && fileExtension !== 'xlsx') {
					showLog('é”™è¯¯: è¯·ä¸Šä¼ .xlsæˆ–.xlsxæ ¼å¼çš„Excelæ–‡ä»¶', 'error');
					return;
				}

				fileName.textContent = file.name;
				fileInfo.classList.remove('hidden');

				// è¯»å–Excelæ–‡ä»¶
				const reader = new FileReader();

				reader.onload = function(e) {
					try {
						const data = new Uint8Array(e.target.result);
						const workbook = XLSX.read(data, {
							type: 'array'
						});

						// è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
						const firstSheetName = workbook.SheetNames[0];
						const worksheet = workbook.Sheets[firstSheetName];

						// è½¬æ¢ä¸ºJSON
						const jsonData = XLSX.utils.sheet_to_json(worksheet);

						if (jsonData.length === 0) {
							showLog('é”™è¯¯: Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®', 'error');
							taxIds = [];
							taxCount.textContent = '0';
							startBtn.disabled = true;
							startBtn.classList.add('btn-disabled');
							return;
						}

						// æŸ¥æ‰¾åŒ…å«"ç¨å·"çš„åˆ—
						const columns = Object.keys(jsonData[0]);
						let taxColumn = null;

						for (const col of columns) {
							if (col.includes('ç¨å·')) {
								taxColumn = col;
								break;
							}
						}

						if (!taxColumn) {
							showLog('é”™è¯¯: Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°åŒ…å«"ç¨å·"çš„åˆ—', 'error');
							showLog(`å¯ç”¨åˆ—å: ${columns.join(', ')}`, 'info');
							taxIds = [];
							taxCount.textContent = '0';
							startBtn.disabled = true;
							startBtn.classList.add('btn-disabled');
							return;
						}

						// æå–ç¨å·æ•°æ®ï¼ˆå»é‡ã€å»ç©ºï¼‰
						taxIds = [...new Set(
							jsonData
							.map(item => item[taxColumn] ? String(item[taxColumn]).trim() : '')
							.filter(id => id !== '')
						)];

						taxCount.textContent = taxIds.length;
						showLog(`æˆåŠŸè¯»å–Excelæ–‡ä»¶ï¼Œæ‰¾åˆ° ${taxIds.length} ä¸ªæœ‰æ•ˆç¨å·`, 'success');

						// å¯ç”¨å¼€å§‹æŒ‰é’®
						if (taxIds.length > 0) {
							startBtn.disabled = false;
							startBtn.classList.remove('btn-disabled');
						} else {
							startBtn.disabled = true;
							startBtn.classList.add('btn-disabled');
							showLog('è­¦å‘Š: æœªæ‰¾åˆ°æœ‰æ•ˆç¨å·', 'warning');
						}

					} catch (error) {
						showLog(`è¯»å–Excelæ–‡ä»¶é”™è¯¯: ${error.message}`, 'error');
						taxIds = [];
						taxCount.textContent = '0';
						startBtn.disabled = true;
						startBtn.classList.add('btn-disabled');
					}
				};

				reader.onerror = function() {
					showLog('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯', 'error');
				};

				reader.readAsArrayBuffer(file);
			}

			// å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			startBtn.addEventListener('click', async () => {
				if (taxIds.length === 0) {
					showLog('é”™è¯¯: æ²¡æœ‰å¯è¯·æ±‚çš„ç¨å·æ•°æ®', 'error');
					return;
				}
				if (isRequesting) {
					showLog('æç¤º: æ‰¹é‡è¯·æ±‚å·²åœ¨è¿›è¡Œä¸­', 'info');
					return;
				}

				// é‡ç½®çŠ¶æ€
				isRequesting = true;
				currentIndex = 0;
				stopRequested = false;
				resetStatistics();

				// æ›´æ–°UIçŠ¶æ€
				startBtn.disabled = true;
				startBtn.classList.add('btn-disabled');
				stopBtn.disabled = false;
				stopBtn.classList.remove('btn-disabled');
				requestStatus.textContent = 'è¯·æ±‚ä¸­...';
				requestStatus.style.color = '#3498db';

				// æ¸…ç©ºç»“æœåˆ—è¡¨
				resultList.innerHTML = '';

				showLog('=== å¼€å§‹æ‰¹é‡è¯·æ±‚ ===', 'info');
				showLog(`å…± ${taxIds.length} ä¸ªç¨å·éœ€è¦å¤„ç†`, 'info');

				// å¼€å§‹æ‰¹é‡è¯·æ±‚
				await processNextTaxId();
			});

			// åœæ­¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			stopBtn.addEventListener('click', () => {
				if (!isRequesting) {
					showLog('æç¤º: æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚', 'info');
					return;
				}

				stopRequested = true;
				requestStatus.textContent = 'æ­£åœ¨åœæ­¢...';
				requestStatus.style.color = '#f39c12';
				showLog('=== è¯·æ±‚åœæ­¢æŒ‡ä»¤å·²å‘å‡º ===', 'warning');
			});

			// å¤„ç†ä¸‹ä¸€ä¸ªç¨å·
			async function processNextTaxId() {
				if (currentIndex >= taxIds.length || stopRequested) {
					// è¯·æ±‚ç»“æŸ
					isRequesting = false;
					requestStatus.textContent = stopRequested ? 'å·²åœæ­¢' : 'å·²å®Œæˆ';
					requestStatus.style.color = stopRequested ? '#f39c12' : '#2ecc71';

					// æ›´æ–°UIçŠ¶æ€
					startBtn.disabled = false;
					startBtn.classList.remove('btn-disabled');
					stopBtn.disabled = true;
					stopBtn.classList.add('btn-disabled');

					// æ˜¾ç¤ºæ€»ç»“
					showLog('=== æ‰¹é‡è¯·æ±‚ç»“æŸ ===', 'info');
					showLog(`å¤„ç†å®Œæˆ: å…± ${requestStats.total} ä¸ªï¼ŒæˆåŠŸ ${requestStats.success} ä¸ªï¼Œå¤±è´¥ ${requestStats.error} ä¸ª`, 'info');

					// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
					updateStatisticsDisplay();

					return;
				}

				// æ›´æ–°è¿›åº¦
				const progress = Math.round((currentIndex+1 / taxIds.length) * 100);
				progressBar.style.width = `${progress}%`;
				progressText.textContent = `${currentIndex}/${taxIds.length}`;
				const taxId = taxIds[currentIndex];
				currentIndex++;
				showLog(`[${currentIndex}/${taxIds.length}] æ­£åœ¨å¤„ç†ç¨å·: ${taxId}`, 'info');
				try {
					// å‘é€XHRè¯·æ±‚
					const responseData = await sendTaxRequest(taxId);
					// å¤„ç†æˆåŠŸå“åº”
					requestStats.total++;
					requestStats.success++;
					// ç»Ÿè®¡æ¶ˆæ¯
					const message = responseData.Message || 'æ— è¿”å›æ¶ˆæ¯';
					if (!requestStats.messages[message]) {
						requestStats.messages[message] = 0;
					}
					requestStats.messages[message]++;
					showLog(`æˆåŠŸ: ${message}`, 'success');
					addResultItem(taxId, 'success', message);
				} catch (error) {
					// å¤„ç†é”™è¯¯
					requestStats.total++;
					requestStats.error++;
					// ç»Ÿè®¡é”™è¯¯æ¶ˆæ¯
					const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
					if (!requestStats.messages[errorMessage]) {
						requestStats.messages[errorMessage] = 0;
					}
					requestStats.messages[errorMessage]++;
					showLog(`å¤±è´¥: ${errorMessage}`, 'error');
					addResultItem(taxId, 'error', errorMessage);
				} finally {
					// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
					updateStatisticsDisplay();
					// å¤„ç†ä¸‹ä¸€ä¸ªï¼ˆæ·»åŠ å°å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹ï¼‰
					setTimeout(processNextTaxId, 300);
				}
			}

			async function sendTaxRequest(taxId) {//å‘èµ·æ‰¹é‡è¯·æ±‚
				return new Promise(async (resolve, reject) => { // å…³é”®ï¼šexecutoræ”¹ä¸ºasyncå‡½æ•°
					try {
						// 1. å…ˆè·å–spidï¼ˆå¿…é¡»ç­‰å¾…å®Œæˆï¼‰
						await getspid(taxId); 
						console.log(`ç¨å·[${taxId}]è·å–åˆ°spid: ${dqspid}`); // ä¿®æ­£ï¼šåŸconsoleæ‹¼å†™é”™è¯¯ï¼ˆå°‘logï¼‰
						
						if(){//åç»­æ ¹æ®è¾“å…¥æˆ–è€…å…¶ä»–æ¡ä»¶æ¥è¿›è¡Œå¢æ”¹
							
						}
						
						// 2. è·å–åˆ°spidåï¼Œæ‰§è¡Œåç»­è¯·æ±‚
						const xhr = new XMLHttpRequest();
						const requestParams = {
							spid: dqspid,
							token: localStorage.getItem("youtoken"),
							qysh: taxId,
							devdll: "GJPT",
							sjspid: dqspid
						};
						const apiUrlV = 'https://51dzfp.cn/NEWKP/TERM/UpdateJBXX';
						const queryStringV = new URLSearchParams(requestParams).toString();
						const fullUrlV = `${apiUrlV}?${queryStringV}`;
						
						xhr.open('post', fullUrlV, true);
						// è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆå¯é€‰ï¼Œé¿å…è¯·æ±‚æŒ‚èµ·ï¼‰
						xhr.timeout = 30000;
						xhr.onload = function() {
							if (xhr.status >= 200 && xhr.status < 300) {
								try {
									const response = JSON.parse(xhr.responseText);
									resolve(response);
								} catch (parseError) {
									reject(new Error(`å“åº”è§£æé”™è¯¯: ${parseError.message}`));
								}
							} else {
								reject(new Error(`HTTPé”™è¯¯: çŠ¶æ€ç  ${xhr.status}`));
							}
						};

						xhr.onerror = function() {
							reject(new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ±‚å¤±è´¥'));
						};

						xhr.ontimeout = function() {
							reject(new Error('è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰'));
						};

						// ä¿®æ­£ï¼šæ„é€ æ­£ç¡®çš„è¯·æ±‚å‚æ•°ï¼ˆåŸparamsæœªå®šä¹‰ï¼‰
						const params = new URLSearchParams(requestParams).toString();
						xhr.send(params);
					} catch (err) {
						// æ•è·getspidçš„é”™è¯¯
						reject(new Error(`è·å–spidå¤±è´¥: ${err.message}`));
					}
				});
			}

			// æ˜¾ç¤ºæ—¥å¿—
			function showLog(message, type = 'info') {
				const now = new Date();
				const timeStr = now.toLocaleTimeString('zh-CN');

				let color = '#7f8c8d'; // info
				if (type === 'success') color = '#2ecc71';
				if (type === 'error') color = '#e74c3c';
				if (type === 'warning') color = '#f39c12';

				const logItem = document.createElement('div');
				logItem.style.color = color;
				logItem.innerHTML = `<span>[${timeStr}]</span> ${message}`;

				logArea.appendChild(logItem);
				logArea.scrollTop = logArea.scrollHeight;
			}

			// æ·»åŠ ç»“æœé¡¹åˆ°å³ä¾§åˆ—è¡¨
			function addResultItem(taxId, type, message) {
				const resultItem = document.createElement('div');
				resultItem.className = `result-item ${type}`;

				const taxIdEl = document.createElement('div');
				taxIdEl.className = 'result-taxid';
				taxIdEl.textContent = `ç¨å·: ${taxId}`;

				const messageEl = document.createElement('div');
				messageEl.className = 'result-message';
				messageEl.textContent = `ç»“æœ: ${message}`;

				resultItem.appendChild(taxIdEl);
				resultItem.appendChild(messageEl);

				// æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
				if (resultList.querySelector('div[style*="text-align: center"]')) {
					resultList.innerHTML = '';
				}
				resultList.appendChild(resultItem);

				// æ›´æ–°ç»“æœè®¡æ•°
				resultCount.textContent = requestStats.total;
			}

			// é‡ç½®ç»Ÿè®¡
			function resetStatistics() {
				requestStats = {
					total: 0,
					success: 0,
					error: 0,
					messages: {}
				};
				statisticsArea.classList.remove('hidden');
				updateStatisticsDisplay();
			}

			// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
			function updateStatisticsDisplay() {
				totalRequests.textContent = requestStats.total;
				successCount.textContent = requestStats.success;
				errorCount.textContent = requestStats.error;

				// æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡
				messageStats.innerHTML = '';

				const messages = Object.entries(requestStats.messages).sort((a, b) => b[1] - a[1]);
				messages.forEach(([message, count]) => {
					const statItem = document.createElement('div');
					statItem.className = 'stat-item';

					// æ¶ˆæ¯è¿‡é•¿æ—¶æˆªæ–­æ˜¾ç¤º
					const displayMessage = message.length > 30 ? message.substring(0, 30) + '...' : message;

					statItem.innerHTML =
						`
                    <span title="${message}">${displayMessage}</span>
                    <span class="status-value">${count} (${requestStats.total > 0 ? Math.round((count/requestStats.total)*100) : 0}%)</span>
                `; // ä¿®æ­£ï¼šé¿å…é™¤ä»¥0

					messageStats.appendChild(statItem);
				});
			}
		</script>
	</body>
</html>